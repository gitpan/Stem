#  File: Stem/Debug.pm

#  This file is part of Stem.
#  Copyright (C) 1999, 2000, 2001 Stem Systems, Inc.

#  Stem is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 2 of the License, or
#  (at your option) any later version.

#  Stem is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.

#  You should have received a copy of the GNU General Public License
#  along with Stem; if not, write to the Free Software
#  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

#  For a license to use the Stem under conditions other than those
#  described here, to purchase support for this software, or to purchase a
#  commercial warranty contract, please contact Stem Systems at:

#       Stem Systems, Inc.		781-643-7504
#  	79 Everett St.			info@stemsystems.com
#  	Arlington, MA 02474
#  	USA

package Stem::Debug ;

use Stem::Vars ;

my $debug_conf = [

	[
		'class'	=>	'Stem::Log',
		'args'	=>	[

			'name'	=>	'debug',
			'dir'	=>	'logs',
			'file'	=>	'debug',
		],
	],
] ;

INIT {

#my $err = Stem::Conf::configure( $debug_conf ) ;
}

#print "Debug [$err]\n" if;

sub import {

	my( $class, %dbg_args ) = @_ ;

	my $use_pkg = caller ;

	my $sub		= $dbg_args{ 'sub' }	|| 'Debug' ;
	my $level	= $dbg_args{ 'level' }	|| 10 ;
	my $label	= $dbg_args{ 'label' }	|| 'debug' ;
	my $log		= $dbg_args{ 'log' }	|| 'debug' ;
	my $env		= $dbg_args{ 'env' } ;
	my $env_level	= $dbg_args{ 'env_level' } || 0 ;
	my $prefix	= $dbg_args{ 'prefix' } ;

	no strict 'refs';

	*{ "${use_pkg}::$sub" } = sub (@) {

		return if $env && $Env{ $env } < $env_level ;

		unless( defined( $prefix ) ) {

			my( $call_pkg, $line_num ) = (caller)[0,2] ;
			$prefix = "$call_pkg:$line_num" ;
		}

# if only 1 arg, it is text.
# if 2 args, it is level, text
# if 3 args, it is label, level, text

		my $text = pop ;
		my $log_level = pop || $level ;
		my $log_label = pop || $label ;

		Stem::Log::entry(
			'log'	=> $log,
			'level'	=> $log_level,		
			'label'	=> $log_label,		
			'text'	=> "$prefix$text\n"
		) ;
	}	
}

1 ;
